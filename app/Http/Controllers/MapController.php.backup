<?php

namespace App\Http\Controllers;

use App\Models\MapPoint;
use Illuminate\Http\Request;
use Inertia\Inertia;

class MapController extends Controller
{
    public function index()
    {
        return Inertia::render('PetaInteraktif');
    }

    public function getLocations(Request $request)
    {
        $csvLocations = $this->getLocationsFromCsv();

        if (!empty($csvLocations)) {
            if ($request->has('category') && $request->category !== 'all') {
                $category = $this->normalizeCategory($request->category);
                $csvLocations = array_values(array_filter(
                    $csvLocations,
                    fn ($location) => $location['category'] === $category
                ));
            }

            return response()->json($csvLocations);
        }

        $locations = MapPoint::where('is_active', true)
            ->get([
                'id',
                'name',
                'category',
                'latitude',
                'longitude',
                'address',
                'description',
            ])
            ->map(function ($location) {
                return [
                    'id' => $location->id,
                    'name' => $location->name,
                    'category' => $this->normalizeCategory($location->category),
                    'latitude' => (float) $location->latitude,
                    'longitude' => (float) $location->longitude,
                    'address' => $location->address,
                    'description' => $location->description,
                    'image_url' => null,
                ];
            })
            ->values()
            ->all();

        if ($request->has('category') && $request->category !== 'all') {
            $category = $this->normalizeCategory($request->category);
            $locations = array_values(array_filter(
                $locations,
                fn ($location) => $location['category'] === $category
            ));
        }

        return response()->json($locations);
    }

    private function getLocationsFromCsv(): array
    {
        $path = storage_path('app/map-data/Data Lokasi Desa Sindang Anom - Sheet1.csv');

        if (!file_exists($path)) {
            return [];
        }

        $handle = fopen($path, 'r');
        if ($handle === false) {
            return [];
        }

        $firstLine = fgets($handle);
        if ($firstLine === false) {
            fclose($handle);
            return [];
        }

        $delimiter = $this->detectDelimiter($firstLine);
        $headers = array_map([$this, 'normalizeHeader'], str_getcsv($firstLine, $delimiter));

        $locations = [];
        $rowId = 1;

        while (($row = fgetcsv($handle, 0, $delimiter)) !== false) {
            if (count($row) === 1 && trim((string) $row[0]) === '') {
                continue;
            }

            $rowData = [];
            foreach ($headers as $index => $header) {
                $rowData[$header] = $row[$index] ?? null;
            }

            $latitude = $this->getFirstValue($rowData, ['latitude', 'lat', 'lintang']);
            $longitude = $this->getFirstValue($rowData, ['longitude', 'lon', 'lng', 'bujur']);

            if (!is_numeric($latitude) || !is_numeric($longitude)) {
                continue;
            }

            $name = $this->getFirstValue($rowData, ['name', 'nama', 'lokasi', 'tempat']);
            $categoryRaw = $this->getFirstValue($rowData, ['category', 'kategori', 'jenis', 'type']);
            $address = $this->getFirstValue($rowData, ['address', 'alamat']);
            $description = $this->getFirstValue($rowData, ['description', 'deskripsi', 'keterangan', 'info']);
            $imageUrl = $this->getFirstValue($rowData, ['image_url', 'image', 'foto', 'gambar', 'url_foto']);

            $locations[] = [
                'id' => 'csv-' . $rowId,
                'name' => $name ?: 'Lokasi ' . $rowId,
                'category' => $this->normalizeCategory($categoryRaw),
                'latitude' => (float) $latitude,
                'longitude' => (float) $longitude,
                'address' => $address,
                'description' => $description,
                'image_url' => $imageUrl,
            ];

            $rowId++;
        }

        fclose($handle);

        return $locations;
    }

    private function detectDelimiter(string $line): string
    {
        $delimiters = [',', ';', "\t", '|'];
        $bestDelimiter = ',';
        $maxCount = 0;

        foreach ($delimiters as $delimiter) {
            $count = substr_count($line, $delimiter);
            if ($count > $maxCount) {
                $maxCount = $count;
                $bestDelimiter = $delimiter;
            }
        }

        return $bestDelimiter;
    }

    private function normalizeHeader(string $header): string
    {
        $header = trim($header);
        $header = preg_replace('/^\xEF\xBB\xBF/', '', $header);
        $header = strtolower($header);
        $header = preg_replace('/[^a-z0-9]+/', '_', $header);

        return trim($header, '_');
    }

    private function getFirstValue(array $row, array $keys): ?string
    {
        foreach ($keys as $key) {
            if (array_key_exists($key, $row) && $row[$key] !== null && $row[$key] !== '') {
                return trim((string) $row[$key]);
            }
        }

        return null;
    }

    private function normalizeCategory(?string $value): string
    {
        $value = strtolower(trim((string) $value));

        if ($value === '') {
            return 'Lainnya';
        }

        $map = [
            'pendidikan' => 'Pendidikan',
            'kesehatan' => 'Kesehatan',
            'pemerintah' => 'Pemerintahan',
            'pemerintahan' => 'Pemerintahan',
            'ibadah' => 'Ibadah',
            'umkm' => 'UMKM',
            'olahraga' => 'Olahraga',
        ];

        return $map[$value] ?? 'Lainnya';
    }
}
